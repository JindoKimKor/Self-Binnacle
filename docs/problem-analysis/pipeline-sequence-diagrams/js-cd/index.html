<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="description" content="**Analysis Target**: `JsJenkins/JenkinsfileDeployment` (JavaScript CD Pipeline)">
  <meta name="author" content="Jindo Kim">
  <title>JS CD Pipeline Sequence Diagrams | Post-Refactoring Analysis</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Roboto+Mono:wght@400;700&display=swap">
  <link rel="stylesheet" href="../../../css/portfolio-theme.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css">
</head>
<body>
  <!-- Mobile hamburger -->
  <button class="nav-toggle" aria-label="Toggle navigation">
    <span></span><span></span><span></span>
  </button>

  <!-- Sidebar overlay (mobile) -->
  <div class="nav-overlay"></div>

  <!-- Sidebar navigation -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <a href="../../../">Post-Refactoring Analysis</a>
    </div>
    <div class="sidebar-content">
      <ul class="nav-tree"><li class="nav-depth-1"><a href="../../../" class="nav-link">Home</a></li><li class="nav-depth-1"><button class="nav-section-btn expanded">Problem Analysis</button><ul class="nav-children"><li class="nav-depth-2"><a href="../../../problem-analysis/problem-analysis-overview/" class="nav-link">Problem Analysis Overview</a></li><li class="nav-depth-2"><a href="../../../problem-analysis/detailed-analysis/" class="nav-link">Detailed Analysis</a></li><li class="nav-depth-2"><a href="../../../problem-analysis/architecture-smells-analysis/" class="nav-link">Architecture Smells Analysis</a></li><li class="nav-depth-2"><a href="../../../problem-analysis/DRY-violation-analysis/" class="nav-link">DRY Violation Analysis</a></li><li class="nav-depth-2"><button class="nav-section-btn expanded">Pipeline Sequence Diagrams</button><ul class="nav-children"><li class="nav-depth-3"><a href="../../../problem-analysis/pipeline-sequence-diagrams/domain-mapping/" class="nav-link">Domain Mapping</a></li><li class="nav-depth-3"><a href="../../../problem-analysis/pipeline-sequence-diagrams/dlx-ci/" class="nav-link">DLXJenkins CI</a></li><li class="nav-depth-3"><a href="../../../problem-analysis/pipeline-sequence-diagrams/dlx-cd/" class="nav-link">DLXJenkins CD</a></li><li class="nav-depth-3"><a href="../../../problem-analysis/pipeline-sequence-diagrams/js-ci/" class="nav-link">JsJenkins CI</a></li><li class="nav-depth-3"><a href="../../../problem-analysis/pipeline-sequence-diagrams/js-cd/" class="nav-link active">JsJenkins CD</a></li><li class="nav-depth-3"><a href="../../../problem-analysis/pipeline-sequence-diagrams/jenkins-ci/" class="nav-link">PipelineForJenkins CI</a></li></ul></li><li class="nav-depth-2"><button class="nav-section-btn">Per-File Analysis</button><ul class="nav-children"><li class="nav-depth-3"><button class="nav-section-btn">generalHelper</button><ul class="nav-children"><li class="nav-depth-4"><a href="../../../problem-analysis/01-generalHelper/01-srp-violation-analysis/" class="nav-link">SRP Violation Analysis</a></li><li class="nav-depth-4"><a href="../../../problem-analysis/01-generalHelper/02-software-smells-analysis/" class="nav-link">Software Smells Analysis</a></li><li class="nav-depth-4"><a href="../../../problem-analysis/01-generalHelper/03-design-smells-symptoms/" class="nav-link">Design Smells Analysis</a></li></ul></li><li class="nav-depth-3"><button class="nav-section-btn">jsHelper</button><ul class="nav-children"><li class="nav-depth-4"><a href="../../../problem-analysis/02-jsHelper/01-srp-violation-analysis/" class="nav-link">SRP Violation Analysis</a></li><li class="nav-depth-4"><a href="../../../problem-analysis/02-jsHelper/02-software-smells-analysis/" class="nav-link">Software Smells Analysis</a></li><li class="nav-depth-4"><a href="../../../problem-analysis/02-jsHelper/03-design-smells-symptoms/" class="nav-link">Design Smells Analysis</a></li></ul></li><li class="nav-depth-3"><button class="nav-section-btn">unityHelper</button><ul class="nav-children"><li class="nav-depth-4"><a href="../../../problem-analysis/03-unityHelper/01-srp-violation-analysis/" class="nav-link">SRP Violation Analysis</a></li><li class="nav-depth-4"><a href="../../../problem-analysis/03-unityHelper/02-software-smells-analysis/" class="nav-link">Software Smells Analysis</a></li><li class="nav-depth-4"><a href="../../../problem-analysis/03-unityHelper/03-design-smells-symptoms/" class="nav-link">Design Smells Analysis</a></li></ul></li><li class="nav-depth-3"><button class="nav-section-btn">DLXJenkins-Jenkinsfile</button><ul class="nav-children"><li class="nav-depth-4"><a href="../../../problem-analysis/04-DLXJenkins-Jenkinsfile/01-srp-violation-analysis/" class="nav-link">SRP Violation Analysis</a></li><li class="nav-depth-4"><a href="../../../problem-analysis/04-DLXJenkins-Jenkinsfile/02-software-smells-analysis/" class="nav-link">Software Smells Analysis</a></li><li class="nav-depth-4"><a href="../../../problem-analysis/04-DLXJenkins-Jenkinsfile/03-design-smells-symptoms/" class="nav-link">Design Smells Analysis</a></li></ul></li><li class="nav-depth-3"><button class="nav-section-btn">DLXJenkins-JenkinsfileDeployment</button><ul class="nav-children"><li class="nav-depth-4"><a href="../../../problem-analysis/05-DLXJenkins-JenkinsfileDeployment/01-srp-violation-analysis/" class="nav-link">SRP Violation Analysis</a></li><li class="nav-depth-4"><a href="../../../problem-analysis/05-DLXJenkins-JenkinsfileDeployment/02-software-smells-analysis/" class="nav-link">Software Smells Analysis</a></li><li class="nav-depth-4"><a href="../../../problem-analysis/05-DLXJenkins-JenkinsfileDeployment/03-design-smells-symptoms/" class="nav-link">Design Smells Analysis</a></li></ul></li><li class="nav-depth-3"><button class="nav-section-btn">JsJenkins-Jenkinsfile</button><ul class="nav-children"><li class="nav-depth-4"><a href="../../../problem-analysis/06-JsJenkins-Jenkinsfile/01-srp-violation-analysis/" class="nav-link">SRP Violation Analysis</a></li><li class="nav-depth-4"><a href="../../../problem-analysis/06-JsJenkins-Jenkinsfile/02-software-smells-analysis/" class="nav-link">Software Smells Analysis</a></li><li class="nav-depth-4"><a href="../../../problem-analysis/06-JsJenkins-Jenkinsfile/03-design-smells-symptoms/" class="nav-link">Design Smells Analysis</a></li></ul></li><li class="nav-depth-3"><button class="nav-section-btn">JsJenkins-JenkinsfileDeployment</button><ul class="nav-children"><li class="nav-depth-4"><a href="../../../problem-analysis/07-JsJenkins-JenkinsfileDeployment/01-srp-violation-analysis/" class="nav-link">SRP Violation Analysis</a></li><li class="nav-depth-4"><a href="../../../problem-analysis/07-JsJenkins-JenkinsfileDeployment/02-software-smells-analysis/" class="nav-link">Software Smells Analysis</a></li><li class="nav-depth-4"><a href="../../../problem-analysis/07-JsJenkins-JenkinsfileDeployment/03-design-smells-symptoms/" class="nav-link">Design Smells Analysis</a></li></ul></li><li class="nav-depth-3"><button class="nav-section-btn">PipelineForJenkins-Jenkinsfile</button><ul class="nav-children"><li class="nav-depth-4"><a href="../../../problem-analysis/08-PipelineForJenkins-Jenkinsfile/01-srp-violation-analysis/" class="nav-link">SRP Violation Analysis</a></li><li class="nav-depth-4"><a href="../../../problem-analysis/08-PipelineForJenkins-Jenkinsfile/02-software-smells-analysis/" class="nav-link">Software Smells Analysis</a></li><li class="nav-depth-4"><a href="../../../problem-analysis/08-PipelineForJenkins-Jenkinsfile/03-design-smells-symptoms/" class="nav-link">Design Smells Analysis</a></li></ul></li></ul></li></ul></li><li class="nav-depth-1"><button class="nav-section-btn">Problem Solving</button><ul class="nav-children"><li class="nav-depth-2"><a href="../../../problem-solving/solution-overview/" class="nav-link">Solution Overview</a></li><li class="nav-depth-2"><a href="../../../problem-solving/solution-by-layer/" class="nav-link">Solution by Layer</a></li><li class="nav-depth-2"><a href="../../../problem-solving/solution-by-feature/" class="nav-link">Solution by Feature</a></li><li class="nav-depth-2"><a href="../../../problem-solving/logger-system-design-integration/" class="nav-link">Logger System Design and Integration</a></li><li class="nav-depth-2"><a href="../../../problem-solving/domain-driven-analysis/" class="nav-link">Domain-Driven Analysis</a></li><li class="nav-depth-2"><a href="../../../problem-solving/jenkins-cps-serialization-diagram/" class="nav-link">Jenkins CPS Serialization Diagram</a></li><li class="nav-depth-2"><a href="../../../problem-solving/pull-request-documentation/" class="nav-link">Pull Request Documentation</a></li><li class="nav-depth-2"><button class="nav-section-btn">Implementation Phases</button><ul class="nav-children"><li class="nav-depth-3"><a href="../../../problem-solving/phase-0-global-trusted-shared-library-setup/changelog/" class="nav-link">Phase 0 - Global Trusted Shared Library Setup</a></li><li class="nav-depth-3"><a href="../../../problem-solving/phase-1-shellscript-modularization-and-initialization-stage/changelog/" class="nav-link">Phase 1 - Shell Script Modularization and Initialization Stage</a></li><li class="nav-depth-3"><a href="../../../problem-solving/phase-2-3-level-logger-system-implementation/changelog/" class="nav-link">Phase 2 - 3-Level Logger System Implementation</a></li><li class="nav-depth-3"><a href="../../../problem-solving/phase-3-bitbucket-api-and-shell-library-integration/changelog/" class="nav-link">Phase 3 - Bitbucket API and Shell Library Integration</a></li><li class="nav-depth-3"><a href="../../../problem-solving/phase-4-full-pipeline-refactoring-and-stage-modularization/changelog/" class="nav-link">Phase 4 - Full Pipeline Refactoring and Stage Modularization</a></li></ul></li></ul></li></ul>
    </div>
  </nav>

  <!-- Main content -->
  <main class="content">
    <div class="container">
      <h1 id="js-cd-pipeline-sequence-diagrams">JS CD Pipeline Sequence Diagrams</h1>
<blockquote>
<p><strong>Analysis Target</strong>: <code>JsJenkins/JenkinsfileDeployment</code> (JavaScript CD Pipeline)</p>
<p><strong>Trigger</strong>: Runs when PR is <code>MERGED</code></p>
<p><strong>Related</strong>: <a href="../../../problem-analysis/pipeline-sequence-diagrams/domain-mapping/">Domain Mapping Summary</a></p>
</blockquote>
<hr />
<h2 id="why-sequence-diagrams">Why Sequence Diagrams?</h2>
<blockquote>
<p><strong>Q: Why use Sequence Diagrams for Jenkins Pipeline analysis?</strong></p>
<p>A: Jenkins Pipeline is <strong>procedural code</strong>. Unlike OOP where classes naturally define domain boundaries, procedural code mixes multiple domains within sequential execution flow. Sequence Diagrams visualize the <strong>call flow</strong> between components, making it easier to identify which domains are involved at each stage.</p>
<p><strong>Q: What is the goal of this analysis?</strong></p>
<p>A: To <strong>identify domains by function</strong>. By tracing "who calls what", I can classify each function into its domain (Git, Bitbucket, Unity, etc.) and detect where domain boundaries are violated (e.g., one function mixing multiple domains).</p>
</blockquote>
<hr />
<h2 id="domain-summary">Domain Summary</h2>
<h3 id="helper-domains-used">Helper Domains Used</h3>
<table>
<thead>
<tr>
<th>Helper</th>
<th>Domain</th>
<th>Functions Called</th>
<th>Used Stage</th>
</tr>
</thead>
<tbody>
<tr>
<td>generalHelper</td>
<td>Git</td>
<td><code>checkoutBranch</code></td>
<td>Post</td>
</tr>
<tr>
<td>generalHelper</td>
<td>Bitbucket</td>
<td><code>getFullCommitHash</code>, <code>sendBuildStatus</code></td>
<td>Prepare WORKSPACE, Post</td>
</tr>
<tr>
<td>generalHelper</td>
<td>SonarQube</td>
<td><code>checkQualityGateStatus</code></td>
<td>Static Analysis</td>
</tr>
<tr>
<td>generalHelper</td>
<td>Parsing</td>
<td><code>parseJson</code></td>
<td>Delete Merged Branch</td>
</tr>
<tr>
<td>jsHelper</td>
<td>Node.js/npm</td>
<td><code>installNpmInTestingDirs</code>, <code>executeLintingInTestingDirs</code>, <code>runUnitTestsInTestingDirs</code>, <code>getPackageJsonVersion</code></td>
<td>Install Dependencies, Linting, Unit Testing, Server/Client Deploy</td>
</tr>
<tr>
<td>jsHelper</td>
<td>File System</td>
<td><code>findTestingDirs</code></td>
<td>Prepare WORKSPACE</td>
</tr>
<tr>
<td>jsHelper</td>
<td>Utility</td>
<td><code>versionCompare</code></td>
<td>Server/Client Deploy</td>
</tr>
</tbody>
</table>
<h3 id="jenkinsfile-direct-calls">Jenkinsfile Direct Calls</h3>
<table>
<thead>
<tr>
<th>Domain</th>
<th>Direct Call</th>
<th>Used Stage</th>
</tr>
</thead>
<tbody>
<tr>
<td>Jenkins Pipeline DSL</td>
<td><code>pipeline</code>, <code>stages</code>, <code>post</code>, <code>script</code>, <code>dir</code>, <code>credentials</code>, <code>tool</code>, <code>withSonarQubeEnv</code>, <code>withCredentials</code>, <code>when</code></td>
<td>All</td>
</tr>
<tr>
<td>Git</td>
<td><code>git clone</code>, <code>git checkout</code>, <code>git reset</code>, <code>git pull</code></td>
<td>Prepare WORKSPACE</td>
</tr>
<tr>
<td>File System</td>
<td><code>find</code>, <code>rm -rf</code>, <code>mkdir -p</code></td>
<td>Delete Merged Branch, Linting</td>
</tr>
<tr>
<td>Node.js</td>
<td><code>node -v</code>, <code>npm -v</code>, <code>npm config ls</code></td>
<td>Install Dependencies</td>
</tr>
<tr>
<td>SonarQube</td>
<td><code>sonar-scanner</code></td>
<td>Static Analysis</td>
</tr>
<tr>
<td>Docker</td>
<td><code>docker info</code>, <code>docker build</code>, <code>docker push</code>, <code>docker rmi</code></td>
<td>Check Condition, Server/Client Deploy</td>
</tr>
<tr>
<td>Azure</td>
<td><code>az login</code>, <code>az acr login</code>, <code>az acr repository show-tags</code>, <code>az containerapp update</code></td>
<td>Check Condition, Server/Client Deploy</td>
</tr>
</tbody>
</table>
<h3 id="domain-mapping-by-stage">Domain Mapping by Stage</h3>
<table>
<thead>
<tr>
<th>Stage</th>
<th style="text-align: center;">Git</th>
<th style="text-align: center;">Bitbucket</th>
<th style="text-align: center;">Node.js</th>
<th style="text-align: center;">SonarQube</th>
<th style="text-align: center;">Docker</th>
<th style="text-align: center;">Azure</th>
<th style="text-align: center;">Parsing</th>
<th style="text-align: center;">File System</th>
<th style="text-align: center;">Utility</th>
</tr>
</thead>
<tbody>
<tr>
<td>Delete Merged Branch</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td>Prepare WORKSPACE</td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td>Install Dependencies</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td>Linting</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td>Unit Testing</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td>Static Analysis</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td>Check Build Condition</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td>Server Build &amp; Deploy</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
</tr>
<tr>
<td>Client Build &amp; Deploy</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
</tr>
<tr>
<td>Post</td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
</tbody>
</table>
<hr />
<h2 id="overall-pipeline-overview">Overall Pipeline Overview</h2>
<div class="mermaid">
flowchart LR
    subgraph Stages
        S1[Delete Merged Branch]
        S2[Prepare WORKSPACE]
        S3[Install Dependencies]
        S4[Linting]
        S5[Unit Testing]
        S6[Static Analysis]
        S7[Check Build Condition]
        S8[Server Build & Deploy]
        S9[Client Build & Deploy]
    end

    S1 --> S2 --> S3 --> S4 --> S5 --> S6 --> S7 --> S8 --> S9

    S9 --> Post[Post<br/>always/success/failure/aborted/unstable]
</div>

<hr />
<h2 id="stage-1-delete-merged-branch">Stage 1: Delete Merged Branch</h2>
<div class="mermaid">
sequenceDiagram
    autonumber

    participant JF as Jenkinsfile<br/>(Orchestrator)
    participant GH as generalHelper
    participant JSH as jsHelper
    participant FS as File System

    Note over JF: Stage: Delete Merged Branch

    JF->>JF: mainBranches.contains(DESTINATION_BRANCH)
    Note over JF: Abort if not merging to main

    JF->>GH: load("generalHelper.groovy")
    JF->>JSH: load("jsHelper.groovy")

    JF->>GH: parseJson()
    Note over GH: Domain: Parsing
    GH-->>JF: buildResults, stageResults

    JF->>FS: find ../ -type d -name "{PR_BRANCH}"
    Note over JF: Jenkinsfile Direct: File System
    FS-->>JF: branch_path

    alt branch_path exists
        JF->>FS: rm -rf {branch_path}
        JF->>FS: rm -rf {branch_path}@tmp
    end

    JF->>JF: FOLDER_NAME = JOB_NAME.split('/').first()
</div>

<hr />
<h2 id="stage-2-prepare-workspace">Stage 2: Prepare WORKSPACE</h2>
<div class="mermaid">
sequenceDiagram
    autonumber

    participant JF as Jenkinsfile<br/>(Orchestrator)
    participant GH as generalHelper
    participant JSH as jsHelper
    participant Git as Git CLI
    participant Python as Python Scripts
    participant BB as Bitbucket API

    Note over JF: Stage: Prepare WORKSPACE

    JF->>GH: getFullCommitHash(workspace, PR_COMMIT)
    Note over GH: Domain: Bitbucket
    GH->>Python: get_bitbucket_commit_hash.py
    Python->>BB: GET /commits
    BB-->>Python: commit hash
    Python-->>GH: full commit hash
    GH-->>JF: COMMIT_HASH

    Note over JF,Git: Jenkinsfile Direct Git Calls
    alt !fileExists(PROJECT_DIR)
        JF->>Git: git clone {REPO_SSH} {PROJECT_DIR}
    end

    JF->>Git: git checkout {DESTINATION_BRANCH}
    JF->>Git: git reset --hard HEAD
    JF->>Git: git pull

    JF->>GH: sendBuildStatus(workspace, 'INPROGRESS', commitHash, true)
    Note over GH: Domain: Bitbucket
    GH->>Python: send_bitbucket_build_status.py -d
    Python->>BB: POST /statuses/build
    BB-->>Python: OK

    JF->>JSH: findTestingDirs(PROJECT_DIR)
    Note over JSH: Domain: File System
    JSH-->>JF: TEST_DIRECTORIES
</div>

<hr />
<h2 id="stage-3-install-dependencies">Stage 3: Install Dependencies</h2>
<div class="mermaid">
sequenceDiagram
    autonumber

    participant JF as Jenkinsfile<br/>(Orchestrator)
    participant JSH as jsHelper
    participant NPM as npm CLI

    Note over JF: Stage: Install Dependencies

    JF->>NPM: node -v
    Note over JF: Jenkinsfile Direct: Node.js
    JF->>NPM: npm -v
    JF->>NPM: npm config ls

    JF->>JSH: installNpmInTestingDirs(TEST_DIRECTORIES)
    Note over JSH: Domain: Node.js/npm
    loop for each testDir
        JSH->>NPM: npm audit
        JSH->>NPM: npm install
        NPM-->>JSH: OK
    end
    JSH-->>JF: OK
</div>

<hr />
<h2 id="stage-4-linting">Stage 4: Linting</h2>
<div class="mermaid">
sequenceDiagram
    autonumber

    participant JF as Jenkinsfile<br/>(Orchestrator)
    participant FS as File System
    participant JSH as jsHelper
    participant NPM as npm CLI

    Note over JF: Stage: Linting

    JF->>FS: mkdir -p linting_results
    Note over JF: Jenkinsfile Direct: File System

    JF->>JSH: executeLintingInTestingDirs(TEST_DIRECTORIES, false)
    Note over JSH: Domain: Node.js/npm
    loop for each testDir
        JSH->>NPM: npm run lint
        NPM-->>JSH: exitCode
    end
    JSH-->>JF: OK/FAIL
</div>

<hr />
<h2 id="stage-5-unit-testing">Stage 5: Unit Testing</h2>
<div class="mermaid">
sequenceDiagram
    autonumber

    participant JF as Jenkinsfile<br/>(Orchestrator)
    participant JSH as jsHelper
    participant NPM as npm CLI

    Note over JF: Stage: Unit Testing

    JF->>JSH: runUnitTestsInTestingDirs(TEST_DIRECTORIES, false)
    Note over JSH: Domain: Node.js/npm
    loop for each testDir
        JSH->>NPM: npm test
        NPM-->>JSH: exitCode
    end
    JSH-->>JF: OK/FAIL
</div>

<blockquote>
<p><strong>Note</strong>: In JS CD, Coverage Report is <strong>not</strong> sent to Bitbucket (differs from CI)</p>
</blockquote>
<hr />
<h2 id="stage-6-static-analysis">Stage 6: Static Analysis</h2>
<div class="mermaid">
sequenceDiagram
    autonumber

    participant JF as Jenkinsfile<br/>(Orchestrator)
    participant GH as generalHelper
    participant SQ as SonarQube

    Note over JF: Stage: Static Analysis

    JF->>SQ: sonar-scanner -Dsonar.projectKey={key} -Dsonar.sources=.
    Note over JF: Jenkinsfile Direct: SonarQube
    SQ-->>JF: analysis queued

    JF->>GH: checkQualityGateStatus(SONAR_PROJECT_KEY, token)
    Note over GH: Domain: SonarQube
    loop retry (max 5)
        GH->>SQ: GET /api/ce/component
        SQ-->>GH: queue status
        alt queue not empty
            GH->>GH: sleep(10)
        else queue empty
            GH->>SQ: GET /api/qualitygates/project_status
            SQ-->>GH: entireCodeStatus, newCodeStatus
        end
    end
    GH-->>JF: PASSED/FAILED

    alt status != OK
        Note over JF: catchError - stage FAILURE
    end
</div>

<hr />
<h2 id="stage-7-check-build-and-deploy-condition">Stage 7: Check Build and Deploy Condition</h2>
<div class="mermaid">
sequenceDiagram
    autonumber

    participant JF as Jenkinsfile<br/>(Orchestrator)
    participant Docker as Docker CLI
    participant AZ as Azure CLI

    Note over JF: Stage: Check Build and Deploy Condition
    Note over JF: Jenkinsfile Direct: Docker + Azure

    JF->>Docker: sudo docker info
    Docker-->>JF: OK/FAIL
    Note over JF: Error if Docker not running

    JF->>AZ: sudo az login --identity
    AZ-->>JF: OK

    JF->>AZ: sudo az acr login --name webbuilds
    AZ-->>JF: OK/FAIL
    Note over JF: Error if ACR login failed
</div>

<hr />
<h2 id="stage-8-server-build-and-deploy">Stage 8: Server Build and Deploy</h2>
<div class="mermaid">
sequenceDiagram
    autonumber

    participant JF as Jenkinsfile<br/>(Orchestrator)
    participant JSH as jsHelper
    participant AZ as Azure CLI
    participant Docker as Docker CLI
    participant ACR as Azure Container Registry

    Note over JF: Stage: Server Build and Deploy
    Note over JF: when: params.SERVER_SOURCE_FOLDER exists

    JF->>AZ: sudo az acr repository show-tags --name webbuilds --repository {SERVER_CONTAINER_NAME}
    Note over JF: Jenkinsfile Direct: Azure
    AZ-->>JF: server_latest_version

    JF->>JSH: getPackageJsonVersion()
    Note over JSH: Domain: Node.js/npm
    JSH-->>JF: project_server_version

    JF->>JSH: versionCompare(server_latest_version, project_server_version)
    Note over JSH: Domain: Utility
    JSH-->>JF: true/false

    alt version is newer
        JF->>Docker: sudo docker build -t {ACR}/{SERVER_CONTAINER_NAME}:{version}
        Note over JF: Jenkinsfile Direct: Docker
        Docker-->>JF: image built

        JF->>Docker: sudo docker push {ACR}/{SERVER_CONTAINER_NAME}:{version}
        Docker->>ACR: push image
        ACR-->>Docker: OK

        JF->>AZ: sudo az containerapp update --name {SERVER_CONTAINER_NAME} --image {version}
        Note over JF: Jenkinsfile Direct: Azure
        AZ-->>JF: OK

        JF->>Docker: sudo docker rmi {image}
        Docker-->>JF: image removed
    else version not newer
        Note over JF: UNSTABLE - Skip deployment
    end
</div>

<hr />
<h2 id="stage-9-client-build-and-deploy">Stage 9: Client Build and Deploy</h2>
<div class="mermaid">
sequenceDiagram
    autonumber

    participant JF as Jenkinsfile<br/>(Orchestrator)
    participant JSH as jsHelper
    participant AZ as Azure CLI
    participant Docker as Docker CLI
    participant ACR as Azure Container Registry

    Note over JF: Stage: Client Build and Deploy
    Note over JF: when: params.CLIENT_SOURCE_FOLDER exists

    JF->>AZ: sudo az acr repository show-tags --name webbuilds --repository {CLIENT_CONTAINER_NAME}
    Note over JF: Jenkinsfile Direct: Azure
    AZ-->>JF: client_latest_version

    JF->>JSH: getPackageJsonVersion()
    Note over JSH: Domain: Node.js/npm
    JSH-->>JF: project_client_version

    JF->>JSH: versionCompare(client_latest_version, project_client_version)
    Note over JSH: Domain: Utility
    JSH-->>JF: true/false

    alt version is newer
        JF->>Docker: sudo docker build -t {ACR}/{CLIENT_CONTAINER_NAME}:{version}
        Note over JF: Jenkinsfile Direct: Docker
        Docker-->>JF: image built

        JF->>Docker: sudo docker push {ACR}/{CLIENT_CONTAINER_NAME}:{version}
        Docker->>ACR: push image
        ACR-->>Docker: OK

        JF->>AZ: sudo az containerapp update --name {CLIENT_CONTAINER_NAME} --image {version}
        Note over JF: Jenkinsfile Direct: Azure
        AZ-->>JF: OK

        JF->>Docker: sudo docker rmi {image}
        Docker-->>JF: image removed
    else version not newer
        Note over JF: UNSTABLE - Skip deployment
    end
</div>

<hr />
<h2 id="post-alwayssuccessfailureabortedunstable">Post: always/success/failure/aborted/unstable</h2>
<div class="mermaid">
sequenceDiagram
    autonumber

    participant JF as Jenkinsfile<br/>(Orchestrator)
    participant GH as generalHelper
    participant Git as Git CLI
    participant Python as Python Scripts
    participant BB as Bitbucket API

    Note over JF: Post: always/success/failure/aborted/unstable

    Note over JF,GH: always block
    JF->>JF: currentBuild.description = PR_BRANCH
    JF->>GH: checkoutBranch(PROJECT_DIR, DESTINATION_BRANCH)
    Note over GH: Domain: Git
    GH->>Git: git reset --hard
    GH->>Git: git clean -fd
    GH->>Git: git checkout {destination}
    GH->>Git: git reset --hard origin/{destination}
    Git-->>GH: OK
    GH-->>JF: OK

    Note over JF,GH: success/failure/aborted/unstable
    alt success
        JF->>GH: sendBuildStatus(workspace, 'SUCCESSFUL', commitHash, true)
    else failure
        JF->>GH: sendBuildStatus(workspace, 'FAILED', commitHash, true)
    else aborted
        JF->>GH: sendBuildStatus(workspace, 'STOPPED', commitHash, true)
    else unstable
        JF->>GH: sendBuildStatus(workspace, 'SUCCESSFUL', commitHash, true)
    end
    Note over GH: Domain: Bitbucket
    GH->>Python: send_bitbucket_build_status.py -d
    Python->>BB: POST /statuses/build
    BB-->>Python: OK
    GH-->>JF: OK
</div>

<hr />
<h2 id="observations">Observations</h2>
<h3 id="delegation-pattern">Delegation Pattern</h3>
<table>
<thead>
<tr>
<th>Pattern</th>
<th>Example</th>
<th style="text-align: center;">Count</th>
</tr>
</thead>
<tbody>
<tr>
<td>Jenkinsfile → generalHelper → External</td>
<td><code>sendBuildStatus</code> → Python → Bitbucket API</td>
<td style="text-align: center;">3</td>
</tr>
<tr>
<td>Jenkinsfile → jsHelper → External</td>
<td><code>installNpmInTestingDirs</code> → npm CLI</td>
<td style="text-align: center;">4</td>
</tr>
<tr>
<td>Jenkinsfile → jsHelper (Utility)</td>
<td><code>versionCompare</code></td>
<td style="text-align: center;">2</td>
</tr>
<tr>
<td>Jenkinsfile → Git direct</td>
<td><code>git clone</code>, <code>git checkout</code>, <code>git pull</code></td>
<td style="text-align: center;">4</td>
</tr>
<tr>
<td>Jenkinsfile → Docker direct</td>
<td><code>docker build</code>, <code>docker push</code>, <code>docker rmi</code></td>
<td style="text-align: center;">8</td>
</tr>
<tr>
<td>Jenkinsfile → Azure direct</td>
<td><code>az login</code>, <code>az acr</code>, <code>az containerapp</code></td>
<td style="text-align: center;">8</td>
</tr>
<tr>
<td>Jenkinsfile → SonarQube direct</td>
<td><code>sonar-scanner</code></td>
<td style="text-align: center;">1</td>
</tr>
<tr>
<td>Jenkinsfile → File System direct</td>
<td><code>find</code>, <code>rm -rf</code>, <code>mkdir</code></td>
<td style="text-align: center;">4</td>
</tr>
</tbody>
</table>
<h3 id="js-ci-vs-js-cd-comparison">JS CI vs JS CD Comparison</h3>
<table>
<thead>
<tr>
<th>Item</th>
<th>JS CI</th>
<th>JS CD</th>
</tr>
</thead>
<tbody>
<tr>
<td>Trigger</td>
<td><code>OPEN</code> (PR created)</td>
<td><code>MERGED</code> (PR merged)</td>
</tr>
<tr>
<td><code>CI_PIPELINE</code></td>
<td><code>true</code></td>
<td><code>false</code></td>
</tr>
<tr>
<td><code>initializeEnvironment</code></td>
<td>✓</td>
<td>✗ (직접 호출)</td>
</tr>
<tr>
<td>Coverage Report Send</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td>Web Server Deploy</td>
<td>Yes (lcov-report)</td>
<td>No</td>
</tr>
<tr>
<td>Docker Build</td>
<td>No</td>
<td>Yes</td>
</tr>
<tr>
<td>Azure Deploy</td>
<td>No</td>
<td>Yes (Container App)</td>
</tr>
<tr>
<td>Delete Merged Branch</td>
<td>No</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<h3 id="inconsistencies">Inconsistencies</h3>
<table>
<thead>
<tr>
<th>Issue</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>No <code>initializeEnvironment</code></td>
<td>CD calls <code>sendBuildStatus</code> directly instead of using mixed function</td>
</tr>
<tr>
<td>Mixed Git delegation</td>
<td>Post uses <code>checkoutBranch</code>, but Prepare WORKSPACE uses direct Git commands</td>
</tr>
<tr>
<td>Heavy Jenkinsfile direct calls</td>
<td>Docker (8), Azure (8), File System (4) - no Helper abstraction</td>
</tr>
<tr>
<td>No Web Server Helper usage</td>
<td>Unlike DLX CD, no deployment to web server via generalHelper</td>
</tr>
</tbody>
</table>
<hr />
<p><a href="../../../problem-analysis/pipeline-sequence-diagrams/js-ci/">← JS CI</a> | <a href="../../../problem-analysis/pipeline-sequence-diagrams/domain-mapping/">Domain Mapping Summary →</a></p>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-groovy.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-json.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: 'dark',
      themeVariables: {
        primaryColor: '#363650',
        primaryTextColor: '#cdd6f4',
        primaryBorderColor: '#6c7bda',
        lineColor: '#a6adc8',
        secondaryColor: '#252536',
        tertiaryColor: '#1e1e2e',
        noteBkgColor: '#2a2a3d',
        noteTextColor: '#cdd6f4',
        actorBkg: '#2a2a3d',
        actorBorder: '#6c7bda',
        actorTextColor: '#cdd6f4',
        signalColor: '#cdd6f4',
        signalTextColor: '#cdd6f4',
        labelBoxBkgColor: '#252536',
        labelBoxBorderColor: '#363650',
        labelTextColor: '#cdd6f4',
        loopTextColor: '#cdd6f4',
        activationBorderColor: '#6c7bda',
        activationBkgColor: '#363650',
        sequenceNumberColor: '#1e1e2e'
      }
    });
  </script>
  
  <script src="../../../js/nav.js"></script>
</body>
</html>