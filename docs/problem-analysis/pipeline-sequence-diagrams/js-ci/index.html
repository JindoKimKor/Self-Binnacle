<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="description" content="**Analysis Target**: `JsJenkins/Jenkinsfile` (JavaScript CI Pipeline)">
  <meta name="author" content="Jindo Kim">
  <title>JS CI Pipeline Sequence Diagrams | Post-Refactoring Analysis</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Roboto+Mono:wght@400;700&display=swap">
  <link rel="stylesheet" href="../../../css/portfolio-theme.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css">
</head>
<body>
  <!-- Mobile hamburger -->
  <button class="nav-toggle" aria-label="Toggle navigation">
    <span></span><span></span><span></span>
  </button>

  <!-- Sidebar overlay (mobile) -->
  <div class="nav-overlay"></div>

  <!-- Sidebar navigation -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <a href="../../../">Post-Refactoring Analysis</a>
    </div>
    <div class="sidebar-content">
      <ul class="nav-tree"><li class="nav-depth-1"><a href="../../../" class="nav-link">Home</a></li><li class="nav-depth-1"><button class="nav-section-btn expanded">Problem Analysis</button><ul class="nav-children"><li class="nav-depth-2"><a href="../../../problem-analysis/problem-analysis-overview/" class="nav-link">Problem Analysis Overview</a></li><li class="nav-depth-2"><a href="../../../problem-analysis/detailed-analysis/" class="nav-link">Detailed Analysis</a></li><li class="nav-depth-2"><a href="../../../problem-analysis/architecture-smells-analysis/" class="nav-link">Architecture Smells Analysis</a></li><li class="nav-depth-2"><a href="../../../problem-analysis/DRY-violation-analysis/" class="nav-link">DRY Violation Analysis</a></li><li class="nav-depth-2"><button class="nav-section-btn expanded">Pipeline Sequence Diagrams</button><ul class="nav-children"><li class="nav-depth-3"><a href="../../../problem-analysis/pipeline-sequence-diagrams/domain-mapping/" class="nav-link">Domain Mapping</a></li><li class="nav-depth-3"><a href="../../../problem-analysis/pipeline-sequence-diagrams/dlx-ci/" class="nav-link">DLXJenkins CI</a></li><li class="nav-depth-3"><a href="../../../problem-analysis/pipeline-sequence-diagrams/dlx-cd/" class="nav-link">DLXJenkins CD</a></li><li class="nav-depth-3"><a href="../../../problem-analysis/pipeline-sequence-diagrams/js-ci/" class="nav-link active">JsJenkins CI</a></li><li class="nav-depth-3"><a href="../../../problem-analysis/pipeline-sequence-diagrams/js-cd/" class="nav-link">JsJenkins CD</a></li><li class="nav-depth-3"><a href="../../../problem-analysis/pipeline-sequence-diagrams/jenkins-ci/" class="nav-link">PipelineForJenkins CI</a></li></ul></li><li class="nav-depth-2"><button class="nav-section-btn">Per-File Analysis</button><ul class="nav-children"><li class="nav-depth-3"><button class="nav-section-btn">generalHelper</button><ul class="nav-children"><li class="nav-depth-4"><a href="../../../problem-analysis/01-generalHelper/01-srp-violation-analysis/" class="nav-link">SRP Violation Analysis</a></li><li class="nav-depth-4"><a href="../../../problem-analysis/01-generalHelper/02-software-smells-analysis/" class="nav-link">Software Smells Analysis</a></li><li class="nav-depth-4"><a href="../../../problem-analysis/01-generalHelper/03-design-smells-symptoms/" class="nav-link">Design Smells Analysis</a></li></ul></li><li class="nav-depth-3"><button class="nav-section-btn">jsHelper</button><ul class="nav-children"><li class="nav-depth-4"><a href="../../../problem-analysis/02-jsHelper/01-srp-violation-analysis/" class="nav-link">SRP Violation Analysis</a></li><li class="nav-depth-4"><a href="../../../problem-analysis/02-jsHelper/02-software-smells-analysis/" class="nav-link">Software Smells Analysis</a></li><li class="nav-depth-4"><a href="../../../problem-analysis/02-jsHelper/03-design-smells-symptoms/" class="nav-link">Design Smells Analysis</a></li></ul></li><li class="nav-depth-3"><button class="nav-section-btn">unityHelper</button><ul class="nav-children"><li class="nav-depth-4"><a href="../../../problem-analysis/03-unityHelper/01-srp-violation-analysis/" class="nav-link">SRP Violation Analysis</a></li><li class="nav-depth-4"><a href="../../../problem-analysis/03-unityHelper/02-software-smells-analysis/" class="nav-link">Software Smells Analysis</a></li><li class="nav-depth-4"><a href="../../../problem-analysis/03-unityHelper/03-design-smells-symptoms/" class="nav-link">Design Smells Analysis</a></li></ul></li><li class="nav-depth-3"><button class="nav-section-btn">DLXJenkins-Jenkinsfile</button><ul class="nav-children"><li class="nav-depth-4"><a href="../../../problem-analysis/04-DLXJenkins-Jenkinsfile/01-srp-violation-analysis/" class="nav-link">SRP Violation Analysis</a></li><li class="nav-depth-4"><a href="../../../problem-analysis/04-DLXJenkins-Jenkinsfile/02-software-smells-analysis/" class="nav-link">Software Smells Analysis</a></li><li class="nav-depth-4"><a href="../../../problem-analysis/04-DLXJenkins-Jenkinsfile/03-design-smells-symptoms/" class="nav-link">Design Smells Analysis</a></li></ul></li><li class="nav-depth-3"><button class="nav-section-btn">DLXJenkins-JenkinsfileDeployment</button><ul class="nav-children"><li class="nav-depth-4"><a href="../../../problem-analysis/05-DLXJenkins-JenkinsfileDeployment/01-srp-violation-analysis/" class="nav-link">SRP Violation Analysis</a></li><li class="nav-depth-4"><a href="../../../problem-analysis/05-DLXJenkins-JenkinsfileDeployment/02-software-smells-analysis/" class="nav-link">Software Smells Analysis</a></li><li class="nav-depth-4"><a href="../../../problem-analysis/05-DLXJenkins-JenkinsfileDeployment/03-design-smells-symptoms/" class="nav-link">Design Smells Analysis</a></li></ul></li><li class="nav-depth-3"><button class="nav-section-btn">JsJenkins-Jenkinsfile</button><ul class="nav-children"><li class="nav-depth-4"><a href="../../../problem-analysis/06-JsJenkins-Jenkinsfile/01-srp-violation-analysis/" class="nav-link">SRP Violation Analysis</a></li><li class="nav-depth-4"><a href="../../../problem-analysis/06-JsJenkins-Jenkinsfile/02-software-smells-analysis/" class="nav-link">Software Smells Analysis</a></li><li class="nav-depth-4"><a href="../../../problem-analysis/06-JsJenkins-Jenkinsfile/03-design-smells-symptoms/" class="nav-link">Design Smells Analysis</a></li></ul></li><li class="nav-depth-3"><button class="nav-section-btn">JsJenkins-JenkinsfileDeployment</button><ul class="nav-children"><li class="nav-depth-4"><a href="../../../problem-analysis/07-JsJenkins-JenkinsfileDeployment/01-srp-violation-analysis/" class="nav-link">SRP Violation Analysis</a></li><li class="nav-depth-4"><a href="../../../problem-analysis/07-JsJenkins-JenkinsfileDeployment/02-software-smells-analysis/" class="nav-link">Software Smells Analysis</a></li><li class="nav-depth-4"><a href="../../../problem-analysis/07-JsJenkins-JenkinsfileDeployment/03-design-smells-symptoms/" class="nav-link">Design Smells Analysis</a></li></ul></li><li class="nav-depth-3"><button class="nav-section-btn">PipelineForJenkins-Jenkinsfile</button><ul class="nav-children"><li class="nav-depth-4"><a href="../../../problem-analysis/08-PipelineForJenkins-Jenkinsfile/01-srp-violation-analysis/" class="nav-link">SRP Violation Analysis</a></li><li class="nav-depth-4"><a href="../../../problem-analysis/08-PipelineForJenkins-Jenkinsfile/02-software-smells-analysis/" class="nav-link">Software Smells Analysis</a></li><li class="nav-depth-4"><a href="../../../problem-analysis/08-PipelineForJenkins-Jenkinsfile/03-design-smells-symptoms/" class="nav-link">Design Smells Analysis</a></li></ul></li></ul></li></ul></li><li class="nav-depth-1"><button class="nav-section-btn">Problem Solving</button><ul class="nav-children"><li class="nav-depth-2"><a href="../../../problem-solving/solution-overview/" class="nav-link">Solution Overview</a></li><li class="nav-depth-2"><a href="../../../problem-solving/solution-by-layer/" class="nav-link">Solution by Layer</a></li><li class="nav-depth-2"><a href="../../../problem-solving/solution-by-feature/" class="nav-link">Solution by Feature</a></li><li class="nav-depth-2"><a href="../../../problem-solving/logger-system-design-integration/" class="nav-link">Logger System Design and Integration</a></li><li class="nav-depth-2"><a href="../../../problem-solving/domain-driven-analysis/" class="nav-link">Domain-Driven Analysis</a></li><li class="nav-depth-2"><a href="../../../problem-solving/jenkins-cps-serialization-diagram/" class="nav-link">Jenkins CPS Serialization Diagram</a></li><li class="nav-depth-2"><a href="../../../problem-solving/pull-request-documentation/" class="nav-link">Pull Request Documentation</a></li><li class="nav-depth-2"><button class="nav-section-btn">Implementation Phases</button><ul class="nav-children"><li class="nav-depth-3"><a href="../../../problem-solving/phase-0-global-trusted-shared-library-setup/changelog/" class="nav-link">Phase 0 - Global Trusted Shared Library Setup</a></li><li class="nav-depth-3"><a href="../../../problem-solving/phase-1-shellscript-modularization-and-initialization-stage/changelog/" class="nav-link">Phase 1 - Shell Script Modularization and Initialization Stage</a></li><li class="nav-depth-3"><a href="../../../problem-solving/phase-2-3-level-logger-system-implementation/changelog/" class="nav-link">Phase 2 - 3-Level Logger System Implementation</a></li><li class="nav-depth-3"><a href="../../../problem-solving/phase-3-bitbucket-api-and-shell-library-integration/changelog/" class="nav-link">Phase 3 - Bitbucket API and Shell Library Integration</a></li><li class="nav-depth-3"><a href="../../../problem-solving/phase-4-full-pipeline-refactoring-and-stage-modularization/changelog/" class="nav-link">Phase 4 - Full Pipeline Refactoring and Stage Modularization</a></li></ul></li></ul></li></ul>
    </div>
  </nav>

  <!-- Main content -->
  <main class="content">
    <div class="container">
      <h1 id="js-ci-pipeline-sequence-diagrams">JS CI Pipeline Sequence Diagrams</h1>
<blockquote>
<p><strong>Analysis Target</strong>: <code>JsJenkins/Jenkinsfile</code> (JavaScript CI Pipeline)</p>
<p><strong>Trigger</strong>: Runs when PR is <code>OPEN</code></p>
<p><strong>Related</strong>: <a href="../../../problem-analysis/pipeline-sequence-diagrams/domain-mapping/">Domain Mapping Summary</a></p>
</blockquote>
<hr />
<h2 id="why-sequence-diagrams">Why Sequence Diagrams?</h2>
<blockquote>
<p><strong>Q: Why use Sequence Diagrams for Jenkins Pipeline analysis?</strong></p>
<p>A: Jenkins Pipeline is <strong>procedural code</strong>. Unlike OOP where classes naturally define domain boundaries, procedural code mixes multiple domains within sequential execution flow. Sequence Diagrams visualize the <strong>call flow</strong> between components, making it easier to identify which domains are involved at each stage.</p>
<p><strong>Q: What is the goal of this analysis?</strong></p>
<p>A: To <strong>identify domains by function</strong>. By tracing "who calls what", I can classify each function into its domain (Git, Bitbucket, Unity, etc.) and detect where domain boundaries are violated (e.g., one function mixing multiple domains).</p>
</blockquote>
<hr />
<h2 id="domain-summary">Domain Summary</h2>
<h3 id="helper-domains-used">Helper Domains Used</h3>
<table>
<thead>
<tr>
<th>Helper</th>
<th>Domain</th>
<th>Functions Called</th>
<th>Used Stage</th>
</tr>
</thead>
<tbody>
<tr>
<td>generalHelper</td>
<td>Git</td>
<td><code>cloneOrUpdateRepo</code>, <code>mergeBranchIfNeeded</code>, <code>isBranchUpToDateWithRemote</code>, <code>checkoutBranch</code></td>
<td>Prepare WORKSPACE, Post</td>
</tr>
<tr>
<td>generalHelper</td>
<td>Bitbucket</td>
<td><code>getFullCommitHash</code>, <code>sendBuildStatus</code></td>
<td>Prepare WORKSPACE, Post</td>
</tr>
<tr>
<td>generalHelper</td>
<td>Web Server</td>
<td><code>publishTestResultsHtmlToWebServer</code></td>
<td>Unit Testing</td>
</tr>
<tr>
<td>generalHelper</td>
<td>SonarQube</td>
<td><code>checkQualityGateStatus</code></td>
<td>Static Analysis</td>
</tr>
<tr>
<td>generalHelper</td>
<td>Parsing</td>
<td><code>parseJson</code></td>
<td>Prepare WORKSPACE</td>
</tr>
<tr>
<td>generalHelper</td>
<td>Mixed (Bitbucket + Parsing)</td>
<td><code>initializeEnvironment</code></td>
<td>Prepare WORKSPACE</td>
</tr>
<tr>
<td>jsHelper</td>
<td>Node.js/npm</td>
<td><code>checkNodeVersion</code>, <code>installNpmInTestingDirs</code>, <code>executeLintingInTestingDirs</code>, <code>runUnitTestsInTestingDirs</code></td>
<td>Install Dependencies, Linting, Unit Testing</td>
</tr>
<tr>
<td>jsHelper</td>
<td>File System</td>
<td><code>findTestingDirs</code>, <code>retrieveReportSummaryDirs</code></td>
<td>Prepare WORKSPACE, Unit Testing</td>
</tr>
</tbody>
</table>
<h3 id="jenkinsfile-direct-calls">Jenkinsfile Direct Calls</h3>
<table>
<thead>
<tr>
<th>Domain</th>
<th>Direct Call</th>
<th>Used Stage</th>
</tr>
</thead>
<tbody>
<tr>
<td>Jenkins Pipeline DSL</td>
<td><code>pipeline</code>, <code>stages</code>, <code>post</code>, <code>script</code>, <code>dir</code>, <code>credentials</code>, <code>tool</code>, <code>withSonarQubeEnv</code>, <code>withCredentials</code></td>
<td>All</td>
</tr>
<tr>
<td>File System</td>
<td><code>mkdir -p</code></td>
<td>Linting</td>
</tr>
<tr>
<td>SonarQube</td>
<td><code>sonar-scanner</code></td>
<td>Static Analysis</td>
</tr>
<tr>
<td>Bitbucket (Python)</td>
<td><code>create_bitbucket_coverage_report.py</code></td>
<td>Unit Testing</td>
</tr>
</tbody>
</table>
<h3 id="domain-mapping-by-stage">Domain Mapping by Stage</h3>
<table>
<thead>
<tr>
<th>Stage</th>
<th style="text-align: center;">Git</th>
<th style="text-align: center;">Bitbucket</th>
<th style="text-align: center;">Node.js</th>
<th style="text-align: center;">Web Server</th>
<th style="text-align: center;">SonarQube</th>
<th style="text-align: center;">Parsing</th>
<th style="text-align: center;">File System</th>
</tr>
</thead>
<tbody>
<tr>
<td>Prepare WORKSPACE</td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
</tr>
<tr>
<td>Install Dependencies</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td>Linting</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
</tr>
<tr>
<td>Unit Testing</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
</tr>
<tr>
<td>Static Analysis</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td>Post</td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
</tbody>
</table>
<hr />
<h2 id="overall-pipeline-overview">Overall Pipeline Overview</h2>
<div class="mermaid">
flowchart LR
    subgraph Stages
        S1[Prepare WORKSPACE]
        S2[Install Dependencies]
        S3[Linting]
        S4[Unit Testing]
        S5[Static Analysis]
    end

    S1 --> S2 --> S3 --> S4 --> S5

    S5 --> Post[Post<br/>always/success/failure/aborted]
</div>

<hr />
<h2 id="stage-1-prepare-workspace">Stage 1: Prepare WORKSPACE</h2>
<div class="mermaid">
sequenceDiagram
    autonumber

    participant JF as Jenkinsfile<br/>(Orchestrator)
    participant GH as generalHelper
    participant JSH as jsHelper
    participant Git as Git CLI
    participant Python as Python Scripts
    participant BB as Bitbucket API

    Note over JF: Stage: Prepare WORKSPACE

    JF->>JF: sh 'env' (print environment variables)
    JF->>GH: load("generalHelper.groovy")
    JF->>JSH: load("jsHelper.groovy")

    JF->>GH: parseJson()
    Note over GH: Domain: Parsing
    GH-->>JF: buildResults, stageResults

    JF->>GH: isBranchUpToDateWithRemote(PR_BRANCH)
    Note over GH: Domain: Git
    GH->>Git: git fetch origin
    GH->>Git: git rev-parse HEAD
    GH->>Git: git rev-parse origin/{branch}
    Git-->>GH: commit hashes
    GH-->>JF: true/false

    JF->>GH: getFullCommitHash(workspace, PR_COMMIT)
    Note over GH: Domain: Bitbucket
    GH->>Python: get_bitbucket_commit_hash.py
    Python->>BB: GET /commits
    BB-->>Python: commit hash
    Python-->>GH: full commit hash
    GH-->>JF: COMMIT_HASH

    JF->>GH: initializeEnvironment(workspace, commitHash, prBranch)
    Note over GH: Mixed: Bitbucket + Parsing
    GH->>GH: sendBuildStatus('INPROGRESS')
    GH->>Python: send_bitbucket_build_status.py
    Python->>BB: POST /statuses/build
    GH->>GH: parseTicketNumber(prBranch)
    GH-->>JF: TICKET_NUMBER, FOLDER_NAME

    JF->>GH: cloneOrUpdateRepo(workspace, projectDir, prBranch)
    Note over GH: Domain: Git
    GH->>Git: git clone / git fetch
    GH->>Git: git checkout
    GH->>Git: git reset --hard
    GH->>Git: git clean -fd
    Git-->>GH: OK
    GH-->>JF: OK

    JF->>GH: mergeBranchIfNeeded(prBranch)
    Note over GH: Domain: Git
    GH->>GH: getDefaultBranch()
    GH->>Git: git remote show origin
    Git-->>GH: default branch
    GH->>GH: isBranchUpToDateWithMain()
    GH->>Git: git merge-base --is-ancestor
    GH->>GH: tryMerge(defaultBranch)
    GH->>Git: git merge origin/{default}
    Git-->>GH: OK
    GH-->>JF: OK

    JF->>JSH: findTestingDirs(PROJECT_DIR)
    Note over JSH: Domain: File System
    JSH-->>JF: TEST_DIRECTORIES
</div>

<hr />
<h2 id="stage-2-install-dependencies">Stage 2: Install Dependencies</h2>
<div class="mermaid">
sequenceDiagram
    autonumber

    participant JF as Jenkinsfile<br/>(Orchestrator)
    participant JSH as jsHelper
    participant NPM as npm CLI

    Note over JF: Stage: Install Dependencies

    JF->>JSH: checkNodeVersion()
    Note over JSH: Domain: Node.js/npm
    JSH->>NPM: node -v
    NPM-->>JSH: version
    JSH->>NPM: npm -v
    NPM-->>JSH: version

    JF->>JSH: installNpmInTestingDirs(TEST_DIRECTORIES)
    Note over JSH: Domain: Node.js/npm
    loop for each testDir
        JSH->>NPM: npm audit
        JSH->>NPM: npm install
        NPM-->>JSH: OK
    end
    JSH-->>JF: OK
</div>

<hr />
<h2 id="stage-3-linting">Stage 3: Linting</h2>
<div class="mermaid">
sequenceDiagram
    autonumber

    participant JF as Jenkinsfile<br/>(Orchestrator)
    participant FS as File System
    participant JSH as jsHelper
    participant NPM as npm CLI

    Note over JF: Stage: Linting

    JF->>FS: mkdir -p linting_results

    JF->>JSH: executeLintingInTestingDirs(TEST_DIRECTORIES, false)
    Note over JSH: Domain: Node.js/npm
    loop for each testDir
        JSH->>NPM: npm run lint
        NPM-->>JSH: exitCode
    end
    JSH-->>JF: OK/FAIL
</div>

<hr />
<h2 id="stage-4-unit-testing">Stage 4: Unit Testing</h2>
<div class="mermaid">
sequenceDiagram
    autonumber

    participant JF as Jenkinsfile<br/>(Orchestrator)
    participant GH as generalHelper
    participant JSH as jsHelper
    participant NPM as npm CLI
    participant Python as Python Scripts
    participant BB as Bitbucket API
    participant WS as Web Server<br/>(SSH/SCP)

    Note over JF: Stage: Unit Testing

    JF->>JSH: runUnitTestsInTestingDirs(TEST_DIRECTORIES, false)
    Note over JSH: Domain: Node.js/npm
    loop for each testDir
        JSH->>NPM: npm test
        NPM-->>JSH: coverage-summary.json, test-results.json
    end
    JSH-->>JF: OK/FAIL

    Note over JF,WS: Publish coverage HTML to Web Server
    JF->>GH: publishTestResultsHtmlToWebServer(FOLDER_NAME, TICKET_NUMBER, lcov-report, 'server')
    Note over GH: Domain: Web Server
    GH->>WS: ssh mkdir -p /var/www/html/{folder}/{ticket}/server
    GH->>WS: scp -r lcov-report/*
    WS-->>GH: OK

    JF->>GH: publishTestResultsHtmlToWebServer(FOLDER_NAME, TICKET_NUMBER, lcov-report, 'client')
    GH->>WS: ssh mkdir -p /var/www/html/{folder}/{ticket}/client
    GH->>WS: scp -r lcov-report/*
    WS-->>GH: OK

    Note over JF,BB: Send coverage reports to Bitbucket
    alt params.SERVER_SOURCE_FOLDER exists
        JF->>JSH: retrieveReportSummaryDirs(serverDir)
        Note over JSH: Domain: File System
        JSH-->>JF: coverageSummaryDir, testSummaryDir
        JF->>Python: create_bitbucket_coverage_report.py --server
        Note over JF: Jenkinsfile Direct: Bitbucket (Python)
        Python->>BB: POST /reports
        BB-->>Python: OK
    end

    alt params.CLIENT_SOURCE_FOLDER exists
        JF->>JSH: retrieveReportSummaryDirs(clientDir)
        JSH-->>JF: coverageSummaryDir, testSummaryDir
        JF->>Python: create_bitbucket_coverage_report.py --client
        Python->>BB: POST /reports
        BB-->>Python: OK
    end
</div>

<hr />
<h2 id="stage-5-static-analysis">Stage 5: Static Analysis</h2>
<div class="mermaid">
sequenceDiagram
    autonumber

    participant JF as Jenkinsfile<br/>(Orchestrator)
    participant GH as generalHelper
    participant SQ as SonarQube

    Note over JF: Stage: Static Analysis

    JF->>SQ: sonar-scanner -Dsonar.projectKey={key} -Dsonar.sources=.
    Note over JF: Jenkinsfile Direct: SonarQube
    SQ-->>JF: analysis queued

    JF->>GH: checkQualityGateStatus(SONAR_PROJECT_KEY, token)
    Note over GH: Domain: SonarQube
    loop retry (max 5)
        GH->>SQ: GET /api/ce/component
        SQ-->>GH: queue status
        alt queue not empty
            GH->>GH: sleep(10)
        else queue empty
            GH->>SQ: GET /api/qualitygates/project_status
            SQ-->>GH: entireCodeStatus, newCodeStatus
        end
    end
    GH-->>JF: PASSED/FAILED

    alt status != OK
        Note over JF: catchError - stage FAILURE
    end
</div>

<hr />
<h2 id="post-alwayssuccessfailureaborted">Post: always/success/failure/aborted</h2>
<div class="mermaid">
sequenceDiagram
    autonumber

    participant JF as Jenkinsfile<br/>(Orchestrator)
    participant GH as generalHelper
    participant Git as Git CLI
    participant Python as Python Scripts
    participant BB as Bitbucket API

    Note over JF: Post: always/success/failure/aborted

    Note over JF,GH: always block
    JF->>JF: currentBuild.description = PR_BRANCH
    JF->>GH: checkoutBranch(PROJECT_DIR, DESTINATION_BRANCH)
    Note over GH: Domain: Git
    GH->>Git: git reset --hard
    GH->>Git: git clean -fd
    GH->>Git: git checkout {destination}
    GH->>Git: git reset --hard origin/{destination}
    Git-->>GH: OK
    GH-->>JF: OK

    Note over JF,GH: success/failure/aborted
    alt success
        JF->>GH: sendBuildStatus(workspace, 'SUCCESSFUL', commitHash, false)
    else failure
        JF->>GH: sendBuildStatus(workspace, 'FAILED', commitHash, false)
    else aborted
        JF->>GH: sendBuildStatus(workspace, 'STOPPED', commitHash, false)
    end
    Note over GH: Domain: Bitbucket
    GH->>Python: send_bitbucket_build_status.py
    Python->>BB: POST /statuses/build
    BB-->>Python: OK
    GH-->>JF: OK
</div>

<hr />
<h2 id="observations">Observations</h2>
<h3 id="delegation-pattern">Delegation Pattern</h3>
<table>
<thead>
<tr>
<th>Pattern</th>
<th>Example</th>
<th style="text-align: center;">Count</th>
</tr>
</thead>
<tbody>
<tr>
<td>Jenkinsfile → generalHelper → External</td>
<td><code>sendBuildStatus</code> → Python → Bitbucket API</td>
<td style="text-align: center;">6</td>
</tr>
<tr>
<td>Jenkinsfile → jsHelper → External</td>
<td><code>installNpmInTestingDirs</code> → npm CLI</td>
<td style="text-align: center;">4</td>
</tr>
<tr>
<td>Jenkinsfile → Python direct</td>
<td><code>create_bitbucket_coverage_report.py</code></td>
<td style="text-align: center;">2</td>
</tr>
<tr>
<td>Jenkinsfile → SonarQube direct</td>
<td><code>sonar-scanner</code></td>
<td style="text-align: center;">1</td>
</tr>
</tbody>
</table>
<h3 id="dlx-ci-vs-js-ci-comparison">DLX CI vs JS CI Comparison</h3>
<table>
<thead>
<tr>
<th>Item</th>
<th>DLX CI</th>
<th>JS CI</th>
</tr>
</thead>
<tbody>
<tr>
<td>Build Tool</td>
<td>Unity CLI</td>
<td>Node.js (npm)</td>
</tr>
<tr>
<td>Helper</td>
<td>unityHelper</td>
<td>jsHelper</td>
</tr>
<tr>
<td>Install Dependencies</td>
<td>No</td>
<td>Yes (<code>installNpmInTestingDirs</code>)</td>
</tr>
<tr>
<td>Linting</td>
<td>Bash Script (C#)</td>
<td>jsHelper (<code>executeLintingInTestingDirs</code>)</td>
</tr>
<tr>
<td>Test Type</td>
<td>EditMode/PlayMode</td>
<td>Jest (<code>runUnitTestsInTestingDirs</code>)</td>
</tr>
<tr>
<td>Code Coverage</td>
<td>Unity Code Coverage</td>
<td>lcov-report</td>
</tr>
<tr>
<td>Static Analysis</td>
<td>No</td>
<td>SonarQube</td>
</tr>
<tr>
<td>Build Project</td>
<td>WebGL</td>
<td>No</td>
</tr>
<tr>
<td><code>initializeEnvironment</code></td>
<td>✓</td>
<td>✓</td>
</tr>
</tbody>
</table>
<h3 id="inconsistencies">Inconsistencies</h3>
<table>
<thead>
<tr>
<th>Issue</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Mixed domain function</td>
<td><code>initializeEnvironment</code> combines Bitbucket + Parsing (SRP violation)</td>
</tr>
<tr>
<td>Direct Python calls</td>
<td><code>create_bitbucket_coverage_report.py</code> bypasses Helper</td>
</tr>
<tr>
<td>Direct SonarQube call</td>
<td><code>sonar-scanner</code> called directly, but <code>checkQualityGateStatus</code> via generalHelper</td>
</tr>
</tbody>
</table>
<hr />
<p><a href="../../../problem-analysis/pipeline-sequence-diagrams/domain-mapping/">← Domain Mapping Summary</a> | <a href="../../../problem-analysis/pipeline-sequence-diagrams/js-cd/">JS CD →</a></p>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-groovy.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-json.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: 'dark',
      themeVariables: {
        primaryColor: '#363650',
        primaryTextColor: '#cdd6f4',
        primaryBorderColor: '#6c7bda',
        lineColor: '#a6adc8',
        secondaryColor: '#252536',
        tertiaryColor: '#1e1e2e',
        noteBkgColor: '#2a2a3d',
        noteTextColor: '#cdd6f4',
        actorBkg: '#2a2a3d',
        actorBorder: '#6c7bda',
        actorTextColor: '#cdd6f4',
        signalColor: '#cdd6f4',
        signalTextColor: '#cdd6f4',
        labelBoxBkgColor: '#252536',
        labelBoxBorderColor: '#363650',
        labelTextColor: '#cdd6f4',
        loopTextColor: '#cdd6f4',
        activationBorderColor: '#6c7bda',
        activationBkgColor: '#363650',
        sequenceNumberColor: '#1e1e2e'
      }
    });
  </script>
  
  <script src="../../../js/nav.js"></script>
</body>
</html>